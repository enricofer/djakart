-- View: MASTER_pub.pi_blob

-- DROP VIEW "MASTER_pub".pi_blob;

CREATE OR REPLACE VIEW "MASTER_pub".pi_blob
 AS
 SELECT row_number() OVER () AS ogc_fid,
    pi_blob.id,
    pi_blob.the_geom,
    pi_blob.filename,
    pi_blob.zto,
    COALESCE(pi_blob.tipo,
        CASE
            WHEN pi_blob.note::text ~~ 'SIR%'::text THEN 'SIR'::text
            ELSE NULL::text
        END::character varying) AS tipo,
    pi_blob.sigla,
    pi_blob.n_scheda,
    pi_blob.tipologia,
    pi_blob.note
   FROM ( SELECT 100000::numeric + zto."ID" AS id,
            st_setsrid(zto.geom, 3003) AS the_geom,
            'b0501011_ZTO'::text AS filename,
            zto."ZTO" AS zto,
                CASE
                    WHEN zto."ZTO"::text = 'D4'::text THEN NULL::character varying
                    ELSE zto.sigla
                END AS tipo,
            zto.sigla,
            NULL::text AS n_scheda,
            NULL::character varying AS tipologia,
            zto.denom AS note
           FROM "MASTER_pub"."b0501011_ZTO" zto
        UNION
         SELECT 200000::numeric + per."ID" AS id,
            st_setsrid(per.geom, 3003) AS the_geom,
            'b0501041_Perimetri'::text AS filename,
            NULL::character varying AS zto,
            per.tipo,
            per.sigla,
            NULL::text AS n_scheda,
            per.sub_tipo AS tipologia,
            per.note
           FROM "MASTER_pub"."b0501041_Perimetri" per
        UNION
         SELECT 400000::numeric + vpro."ID" AS id,
            st_setsrid(vpro.geom, 3003) AS the_geom,
            'b0501051_ViabProg'::text AS filename,
            NULL::character varying AS zto,
            NULL::character varying AS tipo,
            NULL::character varying AS sigla,
            NULL::text AS n_scheda,
            NULL::character varying AS tipologia,
            vpro.nome::character varying AS note
           FROM "MASTER_pub"."b0501051_ViabProg" vpro
        UNION
         SELECT 500000::numeric + anove."ID" AS id,
            st_setsrid(anove.geom, 3003) AS the_geom,
            'b0501061_Architetture900'::text AS filename,
            NULL::character varying AS zto,
            NULL::character varying AS tipo,
            NULL::character varying AS sigla,
            anove."N_scheda"::text AS n_scheda,
            NULL::character varying AS tipologia,
            anove."Denominaz" AS note
           FROM "MASTER_pub"."b0501061_Architetture900" anove
        UNION
         SELECT 600000::numeric + frisp."ID" AS id,
            st_setsrid(frisp.geom, 3003) AS the_geom,
            'b0105021_FasceRispetto'::text AS filename,
            NULL::character varying AS zto,
            frisp."TIPORISP" AS tipo,
            NULL::character varying AS sigla,
            NULL::text AS n_scheda,
            NULL::character varying AS tipologia,
            frisp."ID_RISPETT" AS note
           FROM "MASTER_pub"."b0105021_FasceRispetto" frisp
          WHERE frisp."TIPORISP"::text = ANY (ARRAY['01'::character varying::text, '02'::character varying::text, '11'::character varying::text])
        UNION
         SELECT 700000::numeric + schede."ID" AS id,
            st_setsrid(schede.geom, 3003) AS the_geom,
            'b0501031_Schede'::text AS filename,
            NULL::character varying AS zto,
            schede."Tipo" AS tipo,
            schede."Sigla" AS sigla,
            NULL::text AS n_scheda,
            NULL::character varying AS tipologia,
            schede."Atto" AS note
           FROM "MASTER_pub"."b0501031_Schede" schede
        UNION
         SELECT 800000::numeric + pua."ID" AS id,
            st_setsrid(pua.geom, 3003) AS the_geom,
            'b0501021_AmbPUA'::text AS filename,
            NULL::character varying AS zto,
            pua.tipo,
            pua."id_pua_PI" AS sigla,
            NULL::text AS n_scheda,
            NULL::character varying AS tipologia,
            NULL::character varying AS note
           FROM "MASTER_pub"."b0501021_AmbPUA" pua
        UNION
         SELECT 900000::numeric + cc."ID" AS id,
            st_buffer(st_setsrid(cc.geom, 3003),1) AS the_geom,
            'b0501063_CaseColoniche'::text AS filename,
            NULL::character varying AS zto,
            NULL::character varying AS tipo,
            NULL::character varying AS sigla,
            NULL::text AS n_scheda,
            NULL::character varying AS tipologia,
            NULL::character varying AS note
           FROM "MASTER_pub"."b0501063_CaseColoniche" cc
        UNION
         SELECT 1000000::numeric + inc."ID" AS id,
            st_setsrid(inc.geom, 3003) AS the_geom,
            'b0501071_EdificiIncongrui'::text AS filename,
            NULL::character varying AS zto,
            NULL::character varying AS tipo,
            NULL::character varying AS sigla,
            NULL::text AS n_scheda,
            NULL::character varying AS tipologia,
            NULL::character varying AS note
           FROM "MASTER_pub"."b0501071_EdificiIncongrui" inc) pi_blob
  ORDER BY pi_blob.id DESC;

ALTER TABLE "MASTER_pub".pi_blob
    OWNER TO "istanze-amm";

GRANT ALL ON TABLE "MASTER_pub".pi_blob TO "istanze-amm";
GRANT SELECT ON TABLE "MASTER_pub".pi_blob TO "kart-user";

